<% if can?(:manage, Doorkeeper::Application) and (controller.action_name == "new" or (controller.action_name == "create" and !@application.errors.empty?)) %>
  <div class="panel panel-default">
    <div class="panel-heading panel-title">New Application</div>
    <div class="panel-body">
      <%= simple_form_for @application, :url => oauth_applications_path, :html => { :remote => true } do |f| %>
        <%= f.input :name, input_html: { class: "form-user" } %>
        <%= f.input :redirect_uri, :label => 'Redirect URIs', :input_html => { class: "form-user", :rows => 4 } %>
        <%= f.input :scopes, input_html: { class: "form-user" } %>

        <div class="form-group">
          <%= f.submit "Save", class: "btn btn-default" %>
          <%= link_to "Cancel", oauth_applications_path, { remote: true, class: "btn" } %>
        </div>
      <% end %>
    </div>
  </div>
<% else %>
  <div class="page-header">
    <div class="btn-toolbar pull-right">
      <% if can?(:manage, Doorkeeper::Application) %>
        <div class="btn-group btn-group-sm">
          <%= link_to icon("plus").html_safe, new_oauth_application_path, { remote: true, id: "new-oauth-application", class: "btn btn-default" } %>
        </div>
      <% end %>
    </div>
    <%= form_tag(oauth_applications_path, :method => "get", :class => "form-inline text-center", :role => "form") do %>
      <div class="form-group">
        <%= search_field_tag :query, params[:query], :placeholder => "Search", :class => "form-control" %>
      </div>
      <button type="submit" class="btn btn-default hidden-xs"><%= icon("search") %></button>
      <% unless params[:query].blank? %>
        <%= link_to "clear", oauth_applications_path, :class => "btn" %>
      <% end %>
    <% end %>
  </div>

  <% if can?(:manage, Doorkeeper::Application) %>
    <div class="work">&nbsp;
      <div class="btn-toolbar pull-left">
        <div class="btn-group btn-group-sm">
          <a class="btn btn-default dropdown-toggle" data-toggle="dropdown" href="#"><%= icon("filter") %> <%= params[:user_id].blank? ? "All Applications" : "My Applications" %> <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><%= link_to "All Applications", oauth_applications_path(query: params[:query]) %></li>
            <li><%= link_to "My Applications", oauth_applications_path(user_id: current_user.id, query: params[:query]) %></li>
          </ul>
        </div>
      </div>
    </div>
  <% end %>

  <% if @applications.size > 0 %>
    <div class="panel-group" id="application">
      <% @applications.each do |application| %>
        <div class="panel panel-default">
          <div class="panel-heading panel-title panel-list">
            <%= link_to h(application.name), "#application_#{application.id}", :class => "accordion-toggle", :id => "link_#{application.id}", :data => { :toggle => "collapse", :parent => "#application" }, :href => "#application_#{application.id}" %>
          </div>
          <% if can?(:manage, @application) && @application && @application.id == application.id && (controller.action_name == "edit" or (controller.action_name == "update" and !@application.errors.empty?)) %>
            <div id="application_<%= application.id %>" class="panel-collapse collapse.in">
              <div class="panel-body">
                <%= simple_form_for @application, url: oauth_application_path(@application), html: { role: "form", remote: true } do |f| %>
                  <%= f.input :name, input_html: { class: "form-user" } %>
                  <%= f.input :redirect_uri, :label => 'Redirect URIs', :input_html => { class: "form-user", :rows => 4 } %>
                  <%= f.input :scopes, input_html: { class: "form-user" } %>

                  <div class="form-group">
                    <%= f.submit "Save ", class: "btn btn-default" %>
                    <%= link_to 'Cancel', oauth_applications_path(query: params[:query], user_id: params[:user_id]), { :remote => true, :class => 'btn' } %>
                  </div>
                <% end %>
              </div>
            </div>
          <% else %>
            <div id="application_<%= application.id %>" class="panel-collapse collapse">
              <div class="panel-body">
                <% if can?(:manage, Doorkeeper::Application) %>
                  <div class="btn-toolbar pull-right">
                    <div class="btn-group btn-group-sm">
                      <%= link_to icon("pencil").html_safe, edit_oauth_application_path(application, query: params[:query], user_id: params[:user_id]), remote: true, class: 'btn btn-default btn-sm', id: "#{application.id}-edit" %>
                    </div>
                    <div class="btn-group btn-group-sm">
                      <%= link_to icon("trash").html_safe, oauth_application_path(application, query: params[:query], user_id: params[:user_id]), method: :delete, data: { confirm: 'Are you sure?' }, remote: true, class: 'btn btn-default btn-sm', id: "#{application.id}-delete" %>
                    </div>
                  </div>
                <% end %>

                <h5>Owner</h5>
                <%= link_to application.owner.name, users_path(query: application.owner.uid) %>

                <h5>Client ID</h5>
                <%= application.uid %>

                <h5>Client Secret</h5>
                <%= application.secret %>

                <% unless application.scopes.blank? %>
                  <h5>Scopes</h5>
                  <%= application.scopes %>
                <% end %>

                <h5>Callback URLs</h5>
                <% application.redirect_uri.split.each do |uri| %>
                  <%= uri %><br/>
                <% end %>

                <h5>Application created</h5>
                <%= application.created_at.to_s(:long) %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
    <div class="text-center">
      <%= will_paginate @auth_applications, :params => { :controller => oauth_applications_path, query: params[:query], user_id: params[:user_id] }, :renderer => BootstrapPagination::Rails %>
    </div>
  <% else %>
    <div class="alert alert-info">There are currently no applications
      <% unless params[:query].blank? %>
          with <em><%= params[:query] %></em> in the name
      <% end %>
    </div>
  <% end %>
<% end %>
